---
output:
  pdf_document: 
    fig_width: 6
    fig_height: 4
  html_document: default
editor_options: 
  chunk_output_type: console
---

# Course Practical Assignment - 2nd Deliverable (21 d'abril del 2019)
## *Josep Clotet Ginovart*
## *Eric Martin Obispo*

# Bank client data
## Description of input variables:

  1. age (numeric)
  2. job : type of job (categorical: 'admin', 'blue-collar', 'entrepreneur', 'housemaid', 'management', 'retired', 'self-employed', 'services', 'student', 'technician', 'unemployed', 'unknown')
  3. marital : marital status (categorical: 'divorced','married','single','unknown'; note: 'divorced' means divorced or widowed)
  4. education (categorical:'basic.4y', 'basic.6y', 'basic.9y', 'high.school', 'illiterate', 'professional.course', 'university.degree', 'unknown')
  5. default: has credit in default? (categorical: 'no','yes','unknown')
  6. housing: has housing loan? (categorical: 'no','yes','unknown')
  7. loan: has personal loan? (categorical: 'no','yes','unknown')# related with the last contact of the current campaign:
  8. contact: contact communication type (categorical:'cellular','telephone')
  9. month: last contact month of year (categorical: 'jan', 'feb', 'mar',..., 'nov', 'dec')
  10. day_of_week: last contact day of the week (categorical:'mon','tue','wed','thu','fri')
  11. duration: last contact duration, in seconds (numeric). Important note: this attribute highly affects the output target (e.g., if duration=0 then y='no'). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model.
  12. campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
  13. pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric; 999 means client was not previously contacted)
  14. previous: number of contacts performed before this campaign and for this client (numeric)
  15. poutcome: outcome of the previous marketing campaign (categorical: 'failure','nonexistent','success')# social and economic context attributes
  16. emp.var.rate: employment variation rate - quarterly indicator (numeric)
  17. cons.price.idx: consumer price index - monthly indicator (numeric)
  18. cons.conf.idx: consumer confidence index - monthly indicator (numeric)
  19. euribor3m: euribor 3 month rate - daily indicator (numeric)
  20. nr.employed: number of employees - quarterly indicator (numeric)
  21. y - has the client subscribed a term deposit? (binary: 'yes','no')

# Loading packages:
```{r, include=FALSE}
# Required Packages: to be increased over the course
requiredPackages <- c("car","knitr","ggplot2","FactoMineR","missMDA","mvoutlier","chemometrics", "factoextra", "ggplot2")
missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]

if(length(missingPackages)) install.packages(missingPackages)
lapply(requiredPackages, require, character.only = TRUE)

```

# Load data from Deliverable 1:
```{r}
#dirwd<-"D:/Users/Usuari/Documents/ADEIpractica"
dirwd<-"D:/Documents/GitHub/ADEI"
setwd(dirwd)

#acabar de corregir revisió del delivery 1!!
load( paste0(dirwd, "/bank-additional/Bank5000_validated.RData") )
summary(df)
```


# CORRESPONDENCE ANALYSIS (CA)
Realitzarem un analisi amb taules de correspondencia i mapes de factors entre la variable numerica target duracio discretitzada en 4 nivells (corregit de l'entrega 1) i diversos factors que hem trobat que tenen una correspondencia significativa.

Primer veiem com la duracio de la trucada no te cap relacio amb el job de l'individu, ja que no podem rebutjar la hipotesi *H0: f.duration no té cap relació amb la variable job* amb el valor p obtingut en el Chi Square test. 
Com mes aprop surten al grafic les categories d'ambdues variables analitzades, mes relacionades estan. En aquesta comparacio, com hem s'acaba de comentar, no es pot extreure res significatiu, mes enlla que potser les categories job-unemployed i job-self-employed van mes per lliure.
```{r}
# H0: f.duration no té cap relació amb variable job
chisq.test( table( df$job, df$f.duration) )
# CA - f.duration vs variable job
res.ca<-CA( table( df$job, df$f.duration ) )
lines(res.ca$row$coord[,1], res.ca$row$coord[,2], col="darkblue")
lines(res.ca$col$coord[,1], res.ca$col$coord[,2], col="darkred")
```

Ara testejarem la mateixa hipotesi i mapa pero amb altres categories factor que sí que obtindrem que tenen una relacio significativa. El primer cas es l'epoca de l'any **f.season** en la qual es realitza la trucada (p valor = 2.506e-07).
Comparant el profile de la taula de contingencia de proporcions per fila amb el profile marginal de la duracio veiem com hi ha un 28,5% de trucades amb duracions molt curtes a l'estiu respecte un 25% de trucades amb duracions curtes en tot l'any. D'altra banda, hi ha per sobre d'un 27% de trucades amb duracions llargues a la primavera, respecte un 25% de trucades en la mateixa duracio en tot l'any.
Si comparem el profile de la taula de contingencia de proporcions per columna amb el profile marginal de la f.season veiem com el 42.5% de trucades es realitzen a la primavera, i en canvi més d'un 46% de trucades corresponen a la primavera i a duracions llargues. A més, el 43.7% de trucades es realitzen a l'estiu, i només prop d'un 40% de trucades corresponen a l'estiu i a duracions llargues.
Aquesta mateixa informacio es pot veure representada en un mapa de factors de dues dimensions. Agafant nomes la primera dimensio ja seria suficient per a representar un 98.9% de la variancia del conjunt de les dades.
```{r}
chisq.test( table( df$f.season, df$f.duration) )

#Row/Column profile
prop.table( table(df$f.season, df$f.duration), 1 ) #1->per files
#Marginal Row/Column profile
prop.table( table(df$f.duration)) #1->per files

prop.table( table(df$f.season, df$f.duration), 2 ) #2->per columnes
prop.table( table(df$f.season)) #2->per columnes


res.ca<-CA( table( df$f.season, df$f.duration) )
attributes(res.ca); res.ca$eig #valors eig no normalitzats!
mean(res.ca$eig[,1]) #Kaiser: take as many dimensions as eigenvalue > mean of eigenvalues
#En una taula de correspondencies simples podem tenir màxim tantes 
#dimensions com categories d'una variable menys 1! 
#f.season té 3 cateories -> -1 -> 2 dimensions!!

#La inercia total ens indica com de relacionades estan les dues variables, com més pròxim a 0, menys relacionades estan!
sum(res.ca$eig[,1])

#Coordenades:
#res.ca$row #files son la f.season!
#res.ca$col #columnes son la duration!

```

```{r}
# Contingency tables - complex:
names(df)


#Target f.duration vs variable f.age
table( df$f.age, df$f.duration )
# H0: f.duration no té cap relació amb variable f.age
chisq.test( table( df$f.age, df$f.duration) )
  #Resultat --> X-squared = 17.871, df = 21, p-value = 0.6572 --> no es pot rejectar la H0 amb aquest p-value!, no tenen relació!


#Target f.duration vs variable job
table( df$job, df$f.duration )
#Row/Column profile
prop.table( table(df$job, df$f.duration), 1 ) #1->per files
prop.table( table(df$job, df$f.duration), 2 ) #2->per columnes
#Marginal Row/Column profile
prop.table( table(df$f.duration)) #1->per files
prop.table( table(df$job)) #2->per columnes
# H0: f.duration no té cap relació amb variable job
chisq.test( table( df$job, df$f.duration) )
  #Resultat --> s'hauria de poder rejectar la H0 amb el p-value!, podrem ajudar-nos del job per a predir la duration! Al fer-ho al lab no ens ha donat bé però ens avisa amb un warning pq per a poder fer el test chisq ha d'haver almenys 5 individus a cada cel.la de la taula i com no hem imputat els job-unknown encara no surt bé!!!
#job-unknown         4         8         5         5



# CA - f.duration vs variable f.age
res.ca<-CA( table( df$f.age, df$f.duration ) )

attributes(res.ca)
res.ca$eig #valors eig no normalitzats!
mean(res.ca$eig[,1])

#Kaiser: take as many dimensions as eigenvalue > mean of eigenvalues
#En una taula de correspondencies simples podem tenir màxim tantes dimensions com categories d'una variable menys 1! -> f.age té 4 cateories -> -1 -> 3 dimensions!!

#La inercia total ens indica com de relacionades estan les dues variables, com més pròxim a 0, menys relacionades estan!
sum(res.ca$eig[,1])

#Coordenades:
res.ca$row #files son l'edat!
res.ca$col #columnes son la duracio!

#Link levels in rows:
plot.CA(res.ca)
#Com hem vist abans amb el chisq test, no tenen res a veure l'una amb l'altra:
lines(res.ca$row$coord[,1], res.ca$row$coord[,2], col="darkblue")
lines(res.ca$col$coord[,1], res.ca$col$coord[,2], col="darkred")

#Phi2 = Intensity of the association Chisq/nobservations
sum(res.ca$eig[,1]) #Total inertia = Phi2
17.871/4999 #formula de teoria de total inertia dona el mateix (chisq value/(mostres-1))



# CA - f.duration vs variable job
res.ca<-CA( table( df$job, df$f.duration ) )
res.ca$eig
mean(res.ca$eig[,1]) #mirem la mitja per a agafar X dimensions

#Link levels in rows:
#Com mes aprop surten al grafic les categories d'ambdues variables analitzades, mes relacionades estan. Per exemple, en un cas ben fet sortiria job-unemployed aprop de la categoria de menor duracio (penjen rapidament).
plot.CA(res.ca)
#Com hem vist abans amb el chisq test, tenen a veure:
lines(res.ca$row$coord[,1], res.ca$row$coord[,2], col="darkblue")
lines(res.ca$col$coord[,1], res.ca$col$coord[,2], col="darkred")

#A vegades va be eliminar algunes categories amb pocs individus d'una variable per a poder veure millor les possibles relacions!

#Traditional analysis y vs duration:
chisq.test( table(df$y, df$f.duration) )
table(df$y, df$f.duration)

```


# PCA analysis:
```{r}
# Variables continues
vars_con<-names(df)[c(1, 11:14, 16:20)]; vars_con

res.pca<-PCA( df[, vars_con], quanti.sup=2 ) #"duration" ha de ser suplementaria ja que es la variable target!
#----> Com que "duration" surt quasi centrada, vol dir que les variables vars_con utilitzades en el PCA no ens ajuden a dir res sobre la variable target.

#----> La variable previous (número de contactes en campanyes antigues) esta relacionada inversament amb pdays (dies que feia que no es trucava el client per altres campanyes).
vars_con2<-c(vars_con[1:3], vars_con[5:10]) #sense pdays, més simple
res.pca<-PCA(df[, vars_con2], quanti.sup=2)

#veure eixos 3 i 4:
res.pca<-PCA(df[, vars_con2], quanti.sup=2, axes=3:4)

#Dificil extreure conclusions sobre la duració a partir nomes de les variables numèriques!!
summary(res.pca, nb.dec=2, ncp=4)
#Kaiser would be 2 dim!
#over 80% of variance would be 4 dim!



#-------------nova sessió-----------
#sense duration que se li afegeix a part ara en aquesta sessio de lab!
vars_con<-names(df)[c(1, 12:14, 16:20)]; vars_con

#ara afegim dues variables qualitatives suplementàries!
res.pca<-PCA( df[, c("duration", "y", "marital", vars_con) ], quanti.sup=1, quali.sup=2:3 ) 

#Poc es pot dir del mapa tambe al veure nomes les variables suplementaries ("ind" used to select the individual or categorical variables)
plot.PCA(res.pca, choix="ind", invisible="ind")
plot(res.pca, choix="ind")
plot(res.pca, choix="ind", cex=0.75) #tamany etiquetes

plot(res.pca, choix="ind", cex=0.75, col.ind="grey80")
plot(res.pca, choix="ind", cex=0.75, col.ind="grey80", select="contrib 15") #només pinta les etiquetes dels 15 individus mes contributius!


#3 individus mes contributius al 2n eix:
sort(res.pca$ind$contrib[,2], decreasing=TRUE)[1:3]

#3 individus millor representats al 2n eix:
ll<-sort(res.pca$ind$cos2[,2], decreasing=TRUE)[1:3]; ll
df["39474",] #registre millor representat


#Unir punts de variables suplementaries en el factor map per a una bona representacio:
plot.PCA(res.pca, choix="ind", invisible="ind")
lines(res.pca$quali.sup$coord[1:2, 1:2], col="blue", lwd="2") #target y (2 primeres dim)
lines(res.pca$quali.sup$coord[3:5, 1:2], col="cyan", lwd="2") #variable marital (2 primeres dim)

#Fer el mateix amb la variable duration (factoritzada?) i veure el nuvol de punts i si es pot unir pq segueix alguna progressio!!!


#GGPLOT
#Use modern ggplot facilities per la regla de l'últim colze: at some point the marginal gain will drop, giving an angle in the graph -> mmm in this case would be 3-4 dimensions!?!
fviz_eig(res.pca, addlabels=TRUE)
fviz_eig(res.pca, addlabels=TRUE, choice="eigenvalue")

fviz_pca_var(res.pca)
fviz_contrib(res.pca, choice="var", axes=1:3)+theme_bw()
fviz_contrib(res.pca, choice="var", axes=1:2)+theme_bw()


summary(res.pca, nb.dec=2, ncp=4, nbelements=9, nbind=0)

#valors v.test >1,96 ens indiquen que la categoria ens aporta alguna cosa!
#   --> son les que ens podriem quedar en un subconjunt i que fos l'utlitzat a l'hora de representar graficament i triar els eixos (pels deliverables no cal això!).

```


# K-Means Classification (Partitioning - Supervised learning)
```{r}

#fixed number of groups/clusters:
dclu<-res.pca$ind$coord[,1:4] #only significant axes in order to avoid unnecessary noise

kcla<-kmeans(dclu, 6) #6 clusters in this example

summary(kcla)
#              Length Class  Mode   
# cluster      4986   -none- numeric
# centers        24   -none- numeric
# totss           1   -none- numeric
# withinss        6   -none- numeric
# tot.withinss    1   -none- numeric
# betweenss       1   -none- numeric
# size            6   -none- numeric
# iter            1   -none- numeric
# ifault          1   -none- numeric

table(kcla$cluster) #la variable "kcla$cluster" conté cada observació amb el numero de cluster assignat (com una columna mes)

#INTRA-CLUSTER DISTANCES
kcla$withinss #$withinss: is the within cluster sum of squares. So it results in a vector with a number for each cluster.

#INTER-CLUSTER DISTANCES
kcla$betweenss #$betweenss: is the between clusters sum of squares. In fact it is the mean of distances between cluster centers.

# Some equalities may help to understand:
#     $tot.withinss = sum ($withinss)
#     $totss = $tot.withinss + $betweenss
kcla$betweenss/kcla$totss #nomes amb els centres de gravetat estariem obtenint una representacio de les dades el 77% (en aquest cas)! es molt bona! (provar amb altres valors de números de clusters)


```

# Hierarchical Clustering (Unsupervised learning)
```{r}

#PCA calculat amb 4 significant axes:
res.pca<-PCA( df[, c("duration", "y", "marital", vars_con) ], quanti.sup=1, quali.sup=2:3, ncp=4 ) 

res.hcpc<-HCPC(res.pca, order=TRUE)
attributes(res.hcpc)

summary(res.hcpc$data.clust) #s'inclouen les dades de la mostra i la columna "clust" que indica al nou cluster al qual pertany l'individu

attributes(res.hcpc$desc.var) #tenim variables que hem vist previament al profiling pel cluster!

# Factors globally related to clustering partition:
res.hcpc$desc.var$test.chi2


# Categories over/under represented in each cluster:
res.hcpc$desc.var$category
#----> veiem com hi ha clusters que tenen sobrerepresentacio d'acceptacio del producte financer!


# Numeric (quantitative) variables globally related to clustering partition:
res.hcpc$desc.var$quanti.var
res.hcpc$desc.var$quanti


# Description of the clusters by individuals:
names(res.hcpc$desc.ind)
# Hi ha individus que estan al centre de gravetat del cluster (para) i els que estan mes allunyats de la resta de clusters, es a dir, els mes propis del cluster en questio i menys dels altres (dist).
res.hcpc$desc.ind$para
res.hcpc$desc.ind$dist

#### Characteristic individuals
para1<-which(rownames(res.pca$ind$coord)%in%names(res.hcpc$desc.ind$para[[1]]))
para2<-which(rownames(res.pca$ind$coord)%in%names(res.hcpc$desc.ind$para[[2]]))
para3<-which(rownames(res.pca$ind$coord)%in%names(res.hcpc$desc.ind$para[[3]]))
# to be completed... as many as cluster you choose

dist1<-which(rownames(res.pca$ind$coord)%in%names(res.hcpc$desc.ind$dist[[1]]))
dist2<-which(rownames(res.pca$ind$coord)%in%names(res.hcpc$desc.ind$dist[[2]]))
dist3<-which(rownames(res.pca$ind$coord)%in%names(res.hcpc$desc.ind$dist[[3]]))
# to be completed... as many as cluster you choose

df$clust<-factor(res.hcpc$data.clust$clust)
res.pca<-PCA(df[,c("duration","y","clust",vars_con)],quanti.sup=1,quali.sup=2:3,ncp=4) #cluster as variable suplementaria

?habillage #color the individuals among a categorical variable (give the number/name of the categorical variable)

plot(res.pca, label="none", invisible="quali", habillage="clust")
#pintar "para" del cluster 1
points(res.pca$ind$coord[para1,1], res.pca$ind$coord[para1,2], col="blue", cex=2, pch=16)
#pintar "dist" del cluster 1
points(res.pca$ind$coord[dist1,1], res.pca$ind$coord[dist1,2], col="orange", cex=2, pch=16)

```


