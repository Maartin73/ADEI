---
output:
  pdf_document: default
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Bank client data
## Description of in input variables:

  1. age (numeric)
  2. job : type of job (categorical: 'admin', 'blue-collar', 'entrepreneur', 'housemaid', 'management', 'retired', 'self-employed', 'services', 'student', 'technician', 'unemployed', 'unknown')
  3. marital : marital status (categorical: 'divorced','married','single','unknown'; note: 'divorced' means divorced or widowed)
  4. education (categorical:'basic.4y', 'basic.6y', 'basic.9y', 'high.school', 'illiterate', 'professional.course', 'university.degree', 'unknown')
  5. default: has credit in default? (categorical: 'no','yes','unknown')
  6. housing: has housing loan? (categorical: 'no','yes','unknown')
  7. loan: has personal loan? (categorical: 'no','yes','unknown')# related with the last contact of the current campaign:
  8. contact: contact communication type (categorical:'cellular','telephone')
  9. month: last contact month of year (categorical: 'jan', 'feb', 'mar',..., 'nov', 'dec')
  10. day_of_week: last contact day of the week (categorical:'mon','tue','wed','thu','fri')
  11. duration: last contact duration, in seconds (numeric). Important note: this attribute highly affects the output target (e.g., if duration=0 then y='no'). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model.
  12. campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
  13. pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric; 999 means client was not previously contacted)
  14. previous: number of contacts performed before this campaign and for this client (numeric)
  15. poutcome: outcome of the previous marketing campaign (categorical: 'failure','nonexistent','success')# social and economic context attributes
  16. emp.var.rate: employment variation rate - quarterly indicator (numeric)
  17. cons.price.idx: consumer price index - monthly indicator (numeric)
  18. cons.conf.idx: consumer confidence index - monthly indicator (numeric)
  19. euribor3m: euribor 3 month rate - daily indicator (numeric)
  20. nr.employed: number of employees - quarterly indicator (numeric)
  21. y - has the client subscribed a term deposit? (binary: 'yes','no')

# Loading packages
```{r, include=FALSE}
# Required Packages: to be increased over the course
requiredPackages <- c("car","knitr","ggplot2","FactoMineR","missMDA","mvoutlier","chemometrics")
missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]

if(length(missingPackages)) install.packages(missingPackages)
lapply(requiredPackages, require, character.only = TRUE)

```

# Loading data
```{r}
dirwd<-"d:/Users/Usuari/Documents/ADEI"
setwd(dirwd)

df<-read.table( paste0(dirwd, "/bank-additional/bank-additional-full.csv"),  header=TRUE, sep=";")

# General description of the bank data
head(df)
nrow(df)
ncol(df)
dim(df)

# Selection of our 5000 samples with a specific seed value
set.seed(17041998)
llista<-sample(size=5000, x=1:nrow(df), replace=FALSE)
llista<-sort(llista)

# Overwrite the dataframe with our chosen sample and save the RData
df<-df[llista,]
save.image( paste0(dirwd, "/bank-additional/Bank5000_raw.RData") )

```

# Load our chosen sample
```{r}
#load( paste0(dirwd, "/bank-additional/Bank5000_raw.RData") )

summary(df)
```

# Inicialització del control d'errors, missings i outliers
```{r}
columnes <- names(df) #list of column names

# creem 3 dataframes inicialitzats a 0 d'una fila amb les columnes de la nostra mostra;
# en ells hi posarem el nombre d'errors, missings i outliers per a cada variable
errors <- data.frame(matrix(0, ncol = length(columnes), nrow = 1))
colnames(errors)<-columnes

missings <- data.frame(matrix(0, ncol = length(columnes), nrow = 1))
colnames(missings)<-columnes

outliers <- data.frame(matrix(0, ncol = length(columnes), nrow = 1))
colnames(outliers)<-columnes
<<<<<<< HEAD
=======

df$num_missings <- 0
df$num_outliers <- 0
df$num_errors   <- 0
>>>>>>> origin/master
```


# UNIVARIATE DESCRIPTIVE ANALYSIS (to be included for each variable):
Aquí estudiem cada variable buscant missing values, outliers i possibles errors. En el cas que en trobem, els transformem en NAs i procedim a una imputació manual o els eliminem, o una imputació automàtica (en un chunck posterior d'Imputation).

## QUALITATIVE VARIABLES.
També factoritzem les categories (levels) de les variables qualitatives (discretes).

### Job
```{r}
# Jobs "unknown" will be considered a category, not a missing value.
table(df$job, useNA="always")

# All missing data indicated as NA:
miss<-which(is.na(df$job));
missings$job<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "job-":
df$job<-factor(df$job)
levels(df$job)<-paste0("job-",levels(df$job))

pie(summary(df$job))
```

### Marital
```{r}
# Marital "unknown" will be a missing value (set to NA those considered NA):
sel<-which(df$marital=="unknown");length(sel)
df$marital[sel]<-NA

# All missing data indicated as NA:
miss<-which(is.na(df$marital));
missings$marital<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "marital-":
df$marital<-factor(df$marital)
levels(df$marital)<-paste0("marital-",levels(df$marital))
summary(df$marital)

pie(summary(df$marital))
```

### Education
```{r}
# Education "unknown" will be considered a category, not a missing value.
table(df$education, useNA="always")

# Illiterates are consired as basic.4y.educated
sel<-which(df$education=="illiterate");length(sel)
df[sel, "education"]<-"basic.4y"

# All missing data indicated as NA:
miss<-which(is.na(df$education));
missings$education<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "education-":
df$education<-factor(df$education)
levels(df$education)<-paste0("education-",levels(df$education))

pie(summary(df$education))
```

### Default
```{r}
# Default (owes credit) "unknown" will be considered a category, not a missing value.
table(df$default, useNA="always")

# All missing data indicated as NA:
miss<-which(is.na(df$default));
missings$default<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "default-":
df$default<-factor(df$default)
levels(df$default)<-paste0("default-",levels(df$default))

par(mfrow=c(2,2))
pie(summary(df$default))
```

### Housing
```{r}
# Housing "unknown" will be considered a category, not a missing value.
table(df$housing, useNA="always")

# All missing data indicated as NA:
miss<-which(is.na(df$housing));
missings$housing<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "housing-":
df$housing<-factor(df$housing)
levels(df$housing)<-paste0("housing-",levels(df$housing))

pie(summary(df$housing))
```

### Loan
```{r}
# Loan "unknown" will be considered a category, not a missing value.
table(df$loan, useNA="always")

# All missing data indicated as NA:
miss<-which(is.na(df$loan));
missings$loan<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "loan-":
df$loan<-factor(df$loan)
levels(df$loan)<-paste0("loan-",levels(df$loan))

pie(summary(df$loan))
```

### Contact
```{r}
summary(df$contact)

miss<-which(is.na(df$contact));
missings$contact<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "contact-":
df$contact<-factor(df$contact)
levels(df$contact)<-paste0("contact-",levels(df$contact))

pie(summary(df$contact))
```

### Month
```{r}
miss<-which(is.na(df$month));
missings$month<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "month-":
df$month<-factor(df$month)
levels(df$month)<-paste0("month-",levels(df$month))

par(mfrow=c(1,1))
pie(summary(df$month))

```

#### Month -> definim noves factor categories per Season.
New factors grouping original levels will be considered very positively.
```{r}
# CREATE SEASON COLUMN FROM MONTH:
# Define new factor categories: 1- Spring 2-Summer 3-Autumn, 4-Winter
df$f.season <- 4
# 1 level - spring 
sel<-which(df$month %in% c("month-mar","month-apr","month-may"))
df$f.season[sel] <-1

# 2 level - summer 
sel<-which(df$month %in% c("month-jun","month-jul","month-aug"))
df$f.season[sel] <-2

# 3 level - autumn 
sel<-which(df$month %in% c("month-sep","month-oct","month-nov"))
df$f.season[sel] <-3

df$f.season<-factor(df$f.season, levels=1:4, labels=c("season-spring","season-summer","season-autumn", "season-winter"))

summary(df$f.season);pie(summary(df$f.season))
```

### Day_of_week
```{r}
miss<-which(is.na(df$day_of_week));
missings$day_of_week<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "day_of_week-":
df$day_of_week<-factor(df$day_of_week)
levels(df$day_of_week)<-paste0("day_of_week-",levels(df$day_of_week))

pie(summary(df$day_of_week))
```

### Poutcome (outcome of previous marketing campaign)
```{r}
# Poutcome "nonexistent" will be considered a category, not a missing value.
table(df$poutcome, useNA="always")

# All missing data indicated as NA:
miss<-which(is.na(df$poutcome));
missings$poutcome<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "poutcome-":
df$poutcome<-factor(df$poutcome)
levels(df$poutcome)<-paste0("poutcome-",levels(df$poutcome))

par(mfrow=c(2,1))
pie(summary(df$poutcome))
```

### y (has the client subscribed a term deposit?)
```{r}
miss<-which(is.na(df$y));
missings$y<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Factoritzem les categories (levels) de la columna i afegim l'etiqueta "y-":
df$y<-factor(df$y)
levels(df$y)<-paste0("y-",levels(df$y))

pie(summary(df$y))
```


## QUANTITATIVES VARIABLES.

### Defining some useful functions for outliers detection
```{r}
calcQ <- function(x){
  
  # summary(df$duration)
  #  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  #   0.0   102.0   180.0   258.3   319.0  4918.0 
  
  s.x <- summary(x)
  
  iqr <- s.x[5]-s.x[2] # IQR = Q3([5]) -  Q1([2])
  
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2],
       q2=s.x[3], q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr)
}

```

### Age
```{r}
summary(df$age)
# No tenim cap missing NA!
miss<-which(is.na(df$age))
missings$age<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

par(mfrow=c(1,2))
hist(df$age, breaks=10, main="age - histogram")
Boxplot(df$age)

# Errors are under aged people:
err<-which(df$age < 18)
errors$age<-length(err); length(err)
if(length(err)>0) df<-df[-err,]

# Outliers:
out.var <- calcQ(df$age)
<<<<<<< HEAD
abline(h=out.var[["mouts"]], col="magenta", lwd=2); out.var[["mouts"]]
# But our outliers will be the ones above 100 years:
abline(h=100, col="red", lwd=2)
out<-which(df$age > 100)
outliers$age<-length(out); length(out)
if(length(out)>0) df<-df[-out,]
=======
out.var$souts
# Our outliers will be the ones above 100 years, we don't have any sample with this characteristic

>>>>>>> origin/master

# Final summary of age variable:
par(mfrow=c(1,1))
summary(df$age)
Boxplot(df$age)

```

### Duration
```{r}
summary(df$duration)
# No tenim cap missing NA!
miss<-which(is.na(df$duration));
missings$duration<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

par(mfrow=c(1,2))
hist(df$duration, breaks=20, main="duration - histogram")
Boxplot(df$duration)

# Outliers:
out.var <- calcQ(df$duration)
abline(h=out.var[["mouts"]], col="magenta", lwd=2); out.var[["mouts"]]
abline(h=out.var[["souts"]], col="magenta", lwd=2); out.var[["souts"]]
# But our outliers will be the ones above 1600 and below 10 seconds:
abline(h=1600, col="red", lwd=2)
out<-which( (df$duration < 10) | (df$duration > 1600) )
outliers$duration=length(out); length(out)
<<<<<<< HEAD
=======
df[out, "num_outliers"]<- df[out, "num_outliers"]+1
df[out, "duration"]<-NA
>>>>>>> origin/master
if(length(out)>0) df<-df[-out,]


# Final summary of duration variable:
par(mfrow=c(1,1))
summary(df$duration)
Boxplot(df$duration)
```

#### Duration -> creem una columna de duració en minuts:
```{r}
# CREATE NEW DURATION VARIABLE IN MINUTES:
df$minutes<-df$duration/60
summary(df$minutes)

```

### Campaign
```{r}
summary(df$campaign)
# No tenim cap missing NA!
miss<-which(is.na(df$campaign));
missings$campaign<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

par(mfrow=c(1,2))

hist(df$campaign, breaks=10, main="campaign - histogram")
Boxplot(df$campaign)

# Outliers:
out.var <- calcQ(df$campaign)
abline(h=out.var[["souts"]], col="magenta", lwd=2); out.var[["souts"]]

# But our outliers will be the ones contacted more than 25 times:
abline(h=25, col="red", lwd=2)
out<-which(df$campaign > 25)
df[out, "num_outliers"]<- df[out, "num_outliers"]+1

outliers$campaign=length(out); length(out)

df[out, "campaign"]<-NA
#if(length(out)>0) df<-df[-out,]

# Final summary of campaign variable:
par(mfrow=c(1,1))
summary(df$campaign)
Boxplot(df$campaign)

```

### Pdays
```{r}
# No tenim cap missing NA!
miss<-which(is.na(df$pdays));
missings$pdays<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

# Values that are 999 mean never contacted before:
never<-which(df$pdays==999); length(never)/5000*100

# No outliers!

# Final summary of pdays variable:
summary(df$pdays)
par(mfrow=c(1,2))
hist(df$pdays, breaks=10, main="pdays - histogram")
Boxplot(df$pdays)

```

### Previous
```{r}
# No tenim cap missing NA!
miss<-which(is.na(df$previous));
missings$previous<-length(miss); length(miss)
df[miss, "num_missings"]<- df[miss, "num_missings"]+1

par(mfrow=c(1,2))

hist(df$previous,  main="previous - histogram")

# Final summary of previous variable:
summary(df$previous)
Boxplot(df$previous)
```

### emp.var.rate
```{r}
# Neither missing, outliers nor error values.
par(mfrow=c(1,2))

hist(df$emp.var.rate,  main="emp.var.rate - histogram")
summary(df$emp.var.rate)
Boxplot(df$emp.var.rate)

```

### cons.price.idx
```{r}
# Neither missing, outliers nor error values.
par(mfrow=c(1,2))

hist(df$cons.price.idx,  main="cons.price.idx - histogram")
summary(df$cons.price.idx)
Boxplot(df$cons.price.idx)
```

### cons.conf.idx
```{r}
# Neither missing, outliers nor error values.
par(mfrow=c(1,2))

hist(df$cons.conf.idx,  main="cons.conf.idx - histogram")
summary(df$cons.conf.idx)
Boxplot(df$cons.conf.idx)
```

### euribor3m
```{r}
# Neither missing, outliers nor error values.
par(mfrow=c(1,2))

hist(df$euribor3m,  main="euribor3m - histogram")
summary(df$euribor3m)
Boxplot(df$euribor3m)
```

### nr.employed
```{r}
# Neither missing, outliers nor error values.
par(mfrow=c(1,2))

hist(df$nr.employed,  main="nr.employed - histogram")
summary(df$nr.employed)
Boxplot(df$nr.employed)
```


<<<<<<< HEAD
## DISCRETITZACIÓ DE VARIABLES NUMÈRIQUES:
Original numeric variables corresponding to real quantitative concepts are kept as numeric but additional factors should also be created as a discretization of each numeric variable.
=======
# Missings, outliers and errors
```{r}
# Per variables.
par(mfrow=c(3,1))

barplot( t(c(missings[, 3])), main="total missings per variable", xlab="marital")
barplot( t(c(outliers[, c(11, 12)])), main="total outliers per variable")
barplot( t(c(errors[, 13])), main="total errors per variable")

par(mfrow=c(1,1))

# Els outliers i errors en individus:
table(df$num_missings)
table(df$num_errors)
table(df$num_outliers)
```

# Factors:
```{r}
# CREATE SEASON COLUMN FROM MONTH:
# Define new factor categories: 1- Spring 2-Summer 3-Autumn, 4-Winter
df$f.season <- 4
# 1 level - spring 
sel<-which(df$month %in% c("month-mar","month-apr","month-may"))
df$f.season[sel] <-1

# 2 level - summer 
sel<-which(df$month %in% c("month-jun","month-jul","month-aug"))
df$f.season[sel] <-2

# 3 level - autumn 
sel<-which(df$month %in% c("month-sep","month-oct","month-nov"))
df$f.season[sel] <-3

df$f.season<-factor(df$f.season, levels=1:4, labels=c("season-spring","season-summer","season-autumn", "season-winter"))

summary(df$f.season);pie(summary(df$f.season))
```


```{r}
# CREATE NEW DURATION VARIABLE IN MINUTES:
df$minutes<-df$duration/60
summary(df$minutes)

```


# Discretització de variables numèriques:
>>>>>>> origin/master
```{r}
# AGE
qulist<-quantile(df$age, seq(0,1,0.25), na.rm=TRUE)

df$f.age<-factor( cut(df$age, breaks=qulist, include.lowest=T) )
levels(df$f.age)<-paste0("f.age-", levels(df$f.age) )

# Es mostra una distribució d'edats equitativa amb aquesta factorització:
barplot(table(df$f.age), ylab="frequency")
summary(df$f.age)


# DURATION
qulist<-quantile(df$duration, seq(0,1,0.125), na.rm=TRUE)

df$f.duration<-factor( cut(df$duration, breaks=qulist, include.lowest=T) )
levels(df$f.duration)<-paste0("f.duration-", levels(df$f.duration) )

# Es mostra una distribució de duracions de la trucada equitativa amb aquesta factorització:
barplot(table(df$f.duration), ylab="frequency")
summary(df$f.duration)


# CAMPAIGN
qulist<-quantile(df$campaign, seq(0,1,0.5), na.rm=TRUE)

df$f.campaign<-factor( cut(df$campaign, breaks=c(0,2,5,25), include.lowest=T) )
levels(df$f.campaign)<-paste0("f.campaign-", levels(df$f.campaign) )

# Resultat de la factorització de cops que s'ha contactat al client en la campanya actual:
barplot(table(df$f.campaign), ylab="frequency")
summary(df$f.campaign)


# PDAYS
df$f.pdays<-factor( cut(df$pdays, breaks=c(0, 7, 998, 999), include.lowest=T) )
levels(df$f.pdays)<-paste0("f.pdays-", levels(df$f.pdays) )

levels(df$f.pdays)<-c("f.pdays-[0,7]", "f.pdays-(>7)", "f.pdays-never")

# Resultat de la factorització? dels dies que fa que s'ha contactat al client en una altra campanya:
barplot(table(df$f.pdays), ylab="frequency")
summary(df$f.pdays)


# PREVIOUS
df$f.previous<-factor( cut(df$previous, breaks=c(-Inf, 0, 1, +Inf), include.lowest=T) )
levels(df$f.previous)<-paste0("f.previous-", levels(df$f.previous) )

levels(df$f.previous)<-c("f.previous-never", "f.previous-1", "f.previous-(>1)")

# Resultat de la factorització de number of contacts performed before this campaign and for this client:
barplot(table(df$f.previous), ylab="frequency")
summary(df$f.previous)


# EMP.VAR.RATE
qulist<-quantile(df$emp.var.rate, seq(0,1,0.125), na.rm=TRUE)

df$f.emp.var.rate <-factor( cut(df$emp.var.rate  , breaks=unique(qulist), include.lowest=T) )
levels(df$f.emp.var.rate)<-paste0("f.emp.var.rate-", levels(df$f.emp.var.rate) )

barplot(table(df$f.emp.var.rate), ylab="frequency")
summary(df$f.emp.var.rate)


# CONS.PRICE.IDX
qulist<-quantile(df$cons.price.idx, seq(0,1,0.25), na.rm=TRUE)

df$f.cons.price.idx <-factor( cut(df$cons.price.idx  , breaks=unique(qulist), include.lowest=T) )
levels(df$f.cons.price.idx)<-paste0("f.cons.price.idx-", levels(df$f.cons.price.idx) )

barplot(table(df$f.cons.price.idx), ylab="frequency")
summary(df$f.cons.price.idx)


# CONS.CONF.IDX
qulist<-quantile(df$cons.conf.idx, seq(0,1,0.25), na.rm=TRUE)

df$f.cons.conf.idx <-factor( cut(df$cons.conf.idx  , breaks=unique(qulist), include.lowest=T) )
levels(df$f.cons.conf.idx)<-paste0("f.cons.conf.idx-", levels(df$f.cons.conf.idx) )

barplot(table(df$f.cons.conf.idx), ylab="frequency")
summary(df$f.cons.conf.idx)


# EURIBOR3M
qulist<-quantile(df$euribor3m, seq(0,1,0.25), na.rm=TRUE)

df$f.euribor3m <-factor( cut(df$euribor3m  , breaks=unique(qulist), include.lowest=T) )
levels(df$f.euribor3m)<-paste0("f.euribor3m-", levels(df$f.euribor3m) )

barplot(table(df$f.euribor3m), ylab="frequency")
summary(df$f.euribor3m)


# NR.EMPLOYED
qulist<-quantile(df$nr.employed, seq(0,1,0.25), na.rm=TRUE)

df$f.nr.employed <-factor( cut(df$nr.employed  , breaks=unique(qulist), include.lowest=T) )
levels(df$f.nr.employed)<-paste0("f.nr.employed-", levels(df$f.nr.employed) )

barplot(table(df$f.nr.employed), ylab="frequency")
summary(df$f.nr.employed)


```

## Llistat de variables contínues i discretes:
```{r}
# Llista de variables continues
vars_con<-names(df)[c(1,11:14,16:20,23)]; vars_con

# Llista de variables discretes
vars_dis<-names(df)[c(2:10,15,21:22,24:33)]; vars_dis

#revisar si s'han afegit columnes!

```


# DATA QUALITY REPORT:
## Per variable:
```{r}
# Per variables.
par(mfrow=c(3,1))

barplot( t(c(missings[, 3])), main="total missings per variable", xlab="marital")
barplot( t(c(outliers[, c(1, 11, 12, 13)])), main="total outliers per variable")
barplot( t(c(errors[, 13])), main="total errors per variable")

par(mfrow=c(1,1))

# Els outliers i errors en individus han estat eliminats prèviament!
```

## Per individu:
```{r}

```

<<<<<<< HEAD
### Outliers Multivariants:
=======
# Imputació de valors:
#Variables discretes
>>>>>>> origin/master
```{r}
# Consider subset of numeric variables
summary(df[,vars_con])
vars_con_sub<-vars_con[c(1,2,3,6:10)]
x<-df[,vars_con_sub]
aq.plot(x, delta=qchisq(0.95, df=ncol(x)) )

```



# IMPUTATION
## Factors:
De totes les variables discretes que hem analitzat, hem vist que el "marital" status es podria imputar fàcilment amb imputeMCA(), ja que els unknown (passats prèviament a NA) corresponen només una petita part de la mostra. Com hem vist prèviament, els unknowns han estat considerats categoria pròpia en altres variables.
```{r}
res.impf<-imputeMCA(df[,vars_dis], ncp=10)

# Original:
summary(df$marital)

# Amb dades imputades:
summary(res.impf$completeObs$marital)

# Acceptem la imputació:
df$marital<-res.impf$completeObs[,"marital"]
summary(df[,vars_dis])

```

<<<<<<< HEAD
## Numeric Variables:
La variable numèrica campaign té certs valors que han estat considerats outliers prèviament. Aquí els imputem mitjaçant la imputació automàtica imputePCA().
```{r}

```
=======
#Variables continues
```{r}
# Campaign

res.imp<-imputePCA(df[,vars_con], ncp=10)

# Original:
summary(df$campaign)
# Amb dades imputades:
summary(res.imp$completeObs[,"campaign"])

df$campaign<-res.imp$completeObs[,"campaign"]

summary(df[,vars_con])

```

>>>>>>> origin/master


```{r, include=FALSE}
# Save our validated data as RData
save.image( paste0(dirwd, "/bank-additional/Bank5000_validated.RData") )
```

<<<<<<< HEAD


# PROFILING:
## CONTINOUS DESCRIPTION - Numeric Target (Duration):
```{r}
vars<-names(df); vars
pos_duration<-which(names(df)=="duration"); pos_duration

condes(df, num.var=pos_duration, proba = 0.05)

#crea un llistat de les quantitatives-> assossiació global:
#     les variables que dóna estan relacionades amb duration.
#     llista les variables que tinguin un p-value per sota del 5%

#crea un llistat de les qualitatives->

##crea un llistat de les categories->
#     #Estimate: unitats que està per sobre la duració global quan el registre pertany a la categoria en qüestió

# el p-valor ens diu si l'estimació que f.duration-(484,1.58e+03] sigui 494 per sobre la mitja és per una aleatorietat de les dades o és que és així i és significatiu; com és a dir, com més petit és el p-valor, més lluny de ser veritat està la hipòtesi nula (que diu que no la diferència no està relacionada).

tapply(df$duration, df$f.duration, mean) #mitjana de la duració per categoria de la duració
summary(df$duration) #duració global

tapply(df$duration, df$y, mean) #mitjana de la duració per categoria de la y

oneway.test(df$duration~df$y)
```

## CATEGORICAL DESCRIPTION - Factor (Y, Final Decision):
```{r}
pos_y<-which(names(df)=="y"); pos_y

catdes(df, num.var=pos_y, proba = 0.05)

# $`y-yes`
#                                          Cla/Mod    Mod/Cla Global      p.value     v.test
# f.duration=f.duration-(483,1.58e+03]  40.8064516 44.7787611  12.40 2.180784e-97  20.942837
# poutcome=poutcome-success             62.2641509 17.5221239   3.18 5.331532e-56  15.766007
# f.pdays=f.pdays-[0,6]                 62.2222222 14.8672566   2.70 2.653287e-47  14.446089
# contact=contact-cellular              14.5686901 80.7079646  62.60 6.688527e-23   9.852462

# df: degrees of freedom, #categories - 1

# Dins el cluster que s'ha acceptat el producte financer, la "durada(483 a 1580]" és el 44,778% dels valors, el que és una sobrerepresentació en el cluster y-yes, ja que el global ?s del 12,40%. També hi ha mesos que estan més representats!

# Es donen per ordre d'importància (p-value), per cal interpretar les diferències a ull i veure quines poden donar informació interessant.
=======
#Profiling
##Duration
```{r}
condes(df,11)

tapply(df$duration,df$f.dur,mean)
summary(df$duration)

tapply(df$duration,df$y,mean)
>>>>>>> origin/master

```

##Y
```{r}
condes(df,21)
```


